name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install
        run: npm ci
      
      - name: Lint
        run: npm run lint
      
      - name: Test
        run: npm test
      
      - name: Extract coverage percentage
        run: |
          COVERAGE=$(grep -oP '"lines":\s*\K[0-9.]+' coverage/coverage-summary.json | head -1)
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }} # Ensure you have this if using v4+
      
      - name: Notify Slack on success
        if: success() && env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": "‚úÖ CI/CD Pipeline Succeeded!\n\nüìä *Pipeline Results:*\n- Tests: ‚úÖ Passed\n- Build: ‚úÖ Passed\n- Coverage: ${{ env.COVERAGE }}%\n\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}\n*Author:* ${{ github.actor }}\n\nüéâ All checks passed!"
          }' ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on failure
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": "‚ùå CI/CD Pipeline Failed!\n\nüìä *Pipeline Results:*\n- Tests: ‚ùå Failed\n- Build: ‚ùå Failed\n\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}\n*Author:* ${{ github.actor }}\n\nüîó Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }' ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  release:
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate version
        id: version
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          # Generate new version based on commit messages
          COMMIT_MSG=$(git log --oneline -1 | head -1)
          echo "Commit message: $COMMIT_MSG"
          
          if echo "$COMMIT_MSG" | grep -q "BREAKING CHANGE\|major"; then
            echo "Major version bump triggered"
            # Simple version bumping logic instead of npm version
            IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
            NEW_VERSION="$((major + 1)).0.0"
          elif echo "$COMMIT_MSG" | grep -q "feat:"; then
            echo "Minor version bump triggered"
            IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
            NEW_VERSION="$major.$((minor + 1)).0"
          else
            echo "Patch version bump triggered"
            IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
            NEW_VERSION="$major.$minor.$((patch + 1))"
          fi
          
          echo "New version: $NEW_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        if: env.DOCKER_USERNAME != '' && env.DOCKER_TOKEN != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: false
        id: docker-login
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Verify Docker Hub access
        if: steps.docker-login.outcome == 'success'
        run: |
          echo "Testing Docker Hub access..."
          docker pull hello-world:latest || echo "Docker Hub access test failed"
      
      - name: Build and push Docker image
        if: env.DOCKER_USERNAME != '' && env.DOCKER_TOKEN != ''
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/balance-sheet-pro:${{ steps.version.outputs.tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/balance-sheet-pro:latest
          labels: |
            org.opencontainers.image.title=BalanceSheet Pro
            org.opencontainers.image.description=Financial management application
            org.opencontainers.image.version=${{ steps.version.outputs.new_version }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
      
      - name: Create and push version tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: |
            ## üöÄ Release ${{ steps.version.outputs.tag }}
            
            ### üìã Changes
            - Automated release from main branch
            - Version: ${{ steps.version.outputs.new_version }}
            - Previous: ${{ steps.version.outputs.current_version }}
            
            ### üê≥ Docker Images
            - **Tagged Image**: `${{ secrets.DOCKERHUB_USERNAME }}/balance-sheet-pro:${{ steps.version.outputs.tag }}`
            - **Latest Image**: `${{ secrets.DOCKERHUB_USERNAME }}/balance-sheet-pro:latest`
            
            ### üìä Build Info
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}
            - Build: ${{ github.run_id }}
            
            ### üè∑Ô∏è Labels
            - Version: ${{ steps.version.outputs.new_version }}
            - Created: ${{ github.event.head_commit.timestamp }}
            - Source: ${{ github.repositoryUrl }}
            
            ---
            *This release was automatically created by the CI/CD pipeline.*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Slack on release
        if: success() && env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": "üöÄ New Release Published!\n\nüì¶ *Release Details:*\n- Version: ${{ steps.version.outputs.new_version }}\n- Tag: ${{ steps.version.outputs.tag }}\n- Previous: ${{ steps.version.outputs.current_version }}\n\nüê≥ *Docker Images:*\n- ${{ secrets.DOCKERHUB_USERNAME }}/balance-sheet-pro:${{ steps.version.outputs.tag }}\n- ${{ secrets.DOCKERHUB_USERNAME }}/balance-sheet-pro:latest\n\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}\n*Author:* ${{ github.actor }}\n\nüéâ Release ready for deployment!"
          }' ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}