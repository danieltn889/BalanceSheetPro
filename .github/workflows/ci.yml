name: 4-Stage Pipeline (Notify Every Step)

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  packages: write
  id-token: write
  actions: read
  checks: read
  deployments: write
  issues: read
  pull-requests: read
  repository-projects: read
  security-events: read
  statuses: read

jobs:
  # ------------------------------------------------------------------
  # 1Ô∏è‚É£ FIRST JOB: TEST
  # ------------------------------------------------------------------
  test:
    name: 1. Test & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install & Test
        run: |
          npm ci
          npm test

      # --- NOTIFICATIONS FOR TEST ---
      - name: Slack - Test Success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"‚úÖ [1/4] Tests Passed"}' ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack - Test Failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"‚ùå [1/4] Tests Failed! Stopping pipeline."}' ${{ secrets.SLACK_WEBHOOK_URL }}

  # ------------------------------------------------------------------
  # 2Ô∏è‚É£ SECOND JOB: DOCKER PUBLISH
  # ------------------------------------------------------------------
  docker:
    name: 2. Docker Publish
    needs: test
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Version
        id: version
        run: |
          NEW_VERSION="v1.0.$(date +%s)"
          echo "tag=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/balance-sheet-pro:${{ steps.version.outputs.tag }}

      # --- NOTIFICATIONS FOR DOCKER ---
      - name: Slack - Docker Success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"‚úÖ [2/4] Docker Image Built: ${{ steps.version.outputs.tag }}"}' ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack - Docker Failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"‚ùå [2/4] Docker Build Failed"}' ${{ secrets.SLACK_WEBHOOK_URL }}

  # ------------------------------------------------------------------
  # 3Ô∏è‚É£ THIRD JOB: RELEASE
  # ------------------------------------------------------------------
  release:
    name: 3. Create Release
    needs: docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.docker.outputs.tag }}
          name: Release ${{ needs.docker.outputs.tag }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- NOTIFICATIONS FOR RELEASE ---
      - name: Slack - Release Success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"‚úÖ [3/4] GitHub Release Created"}' ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack - Release Failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"‚ùå [3/4] Release Creation Failed"}' ${{ secrets.SLACK_WEBHOOK_URL }}

  # ------------------------------------------------------------------
  # 4Ô∏è‚É£ FOURTH JOB: KUBERNETES (DEPLOY)
  # ------------------------------------------------------------------
  deploy:
    name: 4. Deploy Local
    needs: [docker, release]
    # ‚ö†Ô∏è Runs on your computer
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Deploy
        run: |
          # Replace image tag in deployment.yaml
          sed -i "s|image: .*|image: ${{ secrets.DOCKERHUB_USERNAME }}/balance-sheet-pro:${{ needs.docker.outputs.tag }}|g" k8s/deployment.yaml
          
          # Apply to local cluster
          kubectl apply -f k8s/deployment.yaml
          kubectl rollout restart deployment/balance-sheet-pro
          
          # Wait for success
          kubectl rollout status deployment/balance-sheet-pro --timeout=60s

      # --- NOTIFICATIONS FOR DEPLOY ---
      - name: Slack - Deploy Success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"üöÄ [4/4] DEPLOYMENT COMPLETE! \n\nVersion ${{ needs.docker.outputs.tag }} is live on your Local Cluster."}' ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack - Deploy Failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"‚ùå [4/4] Deployment Failed on Local Cluster. Check terminal logs."}' ${{ secrets.SLACK_WEBHOOK_URL }}