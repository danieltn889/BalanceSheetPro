name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install
        run: npm ci
      
      - name: Lint
        run: npm run lint
      
      - name: Test
        run: npm test
      
      - name: Extract coverage percentage
        run: |
          COVERAGE=$(grep -oP '"lines":\s*\K[0-9.]+' coverage/coverage-summary.json | head -1)
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }} # Ensure you have this if using v4+
      
      - name: Notify Slack on success
        if: success() && env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": "âœ… CI/CD Pipeline Succeeded!\n\nğŸ“Š *Pipeline Results:*\n- Tests: âœ… Passed\n- Build: âœ… Passed\n- Coverage: ${{ env.COVERAGE }}%\n\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}\n*Author:* ${{ github.actor }}\n\nğŸ‰ All checks passed!"
          }' ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on failure
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": "âŒ CI/CD Pipeline Failed!\n\nğŸ“Š *Pipeline Results:*\n- Tests: âŒ Failed\n- Build: âŒ Failed\n\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}\n*Author:* ${{ github.actor }}\n\nğŸ”— Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }' ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        if: env.DOCKER_USERNAME != '' && env.DOCKER_TOKEN != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true
        id: docker-login
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push
        if: steps.docker-login.outcome == 'success' && startsWith(github.ref, 'refs/tags/')
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/balance-sheet-pro:${{ github.ref_name }}
      
      - name: Notify Slack on Docker success
        if: success() && steps.docker-login.outcome == 'success' && startsWith(github.ref, 'refs/tags/') && env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": "ğŸ³ Docker Image Published!\n\nğŸ“¦ *Image Details:*\n- Repository: ${{ secrets.DOCKERHUB_USERNAME }}/balance-sheet-pro\n- Tag: ${{ github.ref_name }}\n- Full Image: ${{ secrets.DOCKERHUB_USERNAME }}/balance-sheet-pro:${{ github.ref_name }}\n\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}\n*Author:* ${{ github.actor }}\n\nğŸš€ Ready for deployment!"
          }' ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Docker failure
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": "âŒ Docker Publishing Failed!\n\nğŸ“¦ *Failed Details:*\n- Attempted Tag: ${{ github.ref_name }}\n- Repository: ${{ secrets.DOCKERHUB_USERNAME }}/balance-sheet-pro\n\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}\n*Author:* ${{ github.actor }}\n\nğŸ”§ Check Docker Hub credentials and build logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }' ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  release:
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate version
        id: version
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          
          # Generate new version based on commit messages
          if git log --oneline -1 | grep -q "BREAKING CHANGE\|major"; then
            NEW_VERSION=$(npm version major --no-git-tag-version | sed 's/^v//')
          elif git log --oneline -1 | grep -q "feat:"; then
            NEW_VERSION=$(npm version minor --no-git-tag-version | sed 's/^v//')
          else
            NEW_VERSION=$(npm version patch --no-git-tag-version | sed 's/^v//')
          fi
          
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
      
      - name: Create and push version tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}
      
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          release_name: Release ${{ steps.version.outputs.tag }}
          body: |
            ## ğŸš€ Release ${{ steps.version.outputs.tag }}
            
            ### ğŸ“‹ Changes
            - Automated release from main branch
            - Version: ${{ steps.version.outputs.new_version }}
            - Previous: ${{ steps.version.outputs.current_version }}
            
            ### ğŸ³ Docker Image
            - Available: `${{ secrets.DOCKERHUB_USERNAME }}/balance-sheet-pro:${{ steps.version.outputs.tag }}`
            
            ### ğŸ“Š Build Info
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}
            - Build: ${{ github.run_id }}
            
            ---
            *This release was automatically created by the CI/CD pipeline.*
          draft: false
          prerelease: false

      - name: Notify Slack on release
        if: success() && env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": "ğŸš€ New Release Published!\n\nğŸ“¦ *Release Details:*\n- Version: ${{ steps.version.outputs.new_version }}\n- Tag: ${{ steps.version.outputs.tag }}\n- Previous: ${{ steps.version.outputs.current_version }}\n\nğŸ³ *Docker Image:*\n- ${{ secrets.DOCKERHUB_USERNAME }}/balance-sheet-pro:${{ steps.version.outputs.tag }}\n\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}\n*Author:* ${{ github.actor }}\n\nğŸ‰ Release ready for deployment!"
          }' ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}